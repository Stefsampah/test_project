<div class="shorts-container">
  <% if @game.current_video %>
    <div class="shorts-player">
      <!-- Vidéo -->
      <div class="shorts-video">
        <div id="video-container-<%= @game.current_video.id %>" style="width: 100%; height: 100%; position: relative;">
          <% 
            # Détection Safari mobile côté serveur pour optimiser les paramètres
            is_safari_mobile = request.user_agent.to_s.match?(/iPhone|iPad|iPod/)
            mute_param = is_safari_mobile ? '1' : '0'
            base_url = request.base_url
            video_url = "https://www.youtube.com/embed/#{@game.current_video.youtube_id}?autoplay=1&controls=0&modestbranding=1&rel=0&playsinline=1&fs=1&disablekb=1&iv_load_policy=3&cc_load_policy=0&mute=#{mute_param}&loop=0&showinfo=0&enablejsapi=1&origin=#{CGI.escape(base_url)}"
          %>
          <iframe 
            id="youtube-player-<%= @game.current_video.id %>"
            src="<%= video_url %>"
            title="YouTube video player"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen="true"
            style="width: 100vw !important; height: calc(100vh - 120px) !important; position: fixed !important; top: 0 !important; left: 0 !important; border: none !important; pointer-events: auto !important; z-index: 1 !important; transform: scale(2.2) !important; transform-origin: center center !important; object-fit: cover !important;">
          </iframe>
          
          <!-- Overlay de chargement pour Safari mobile -->
          <div id="video-loading-<%= @game.current_video.id %>" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5; display: flex; align-items: center; justify-content: center; flex-direction: column;">
            <div style="color: white; text-align: center; padding: 20px;">
              <p style="margin-bottom: 20px; font-size: 18px;">Chargement de la vidéo...</p>
              <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
          </div>
          
          <!-- Message d'erreur avec bouton de retry -->
          <div id="video-error-<%= @game.current_video.id %>" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; background: rgba(0,0,0,0.9); padding: 30px; border-radius: 15px; color: white; text-align: center; max-width: 90%;">
            <p style="margin-bottom: 20px; font-size: 16px;">La vidéo ne se charge pas</p>
            <button onclick="retryVideoLoad('<%= @game.current_video.id %>', '<%= @game.current_video.youtube_id %>')" style="background: #9333ea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">Réessayer</button>
            <p style="margin-top: 15px; font-size: 12px; opacity: 0.7;">Si le problème persiste, essayez de rafraîchir la page</p>
          </div>
        </div>
        
        <style>
          @keyframes spin {
            to { transform: rotate(360deg); }
          }
        </style>
        
        <script>
          (function() {
            const videoId = '<%= @game.current_video.id %>';
            const youtubeId = '<%= @game.current_video.youtube_id %>';
            const iframe = document.getElementById('youtube-player-' + videoId);
            const loadingDiv = document.getElementById('video-loading-' + videoId);
            const errorDiv = document.getElementById('video-error-' + videoId);
            
            if (!iframe) return;
            
            // Détection Safari mobile
            const isSafariMobile = /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            let loadCheckTimeout;
            let hasLoaded = false;
            let errorShown = false;
            
            // Fonction pour masquer le loader et afficher la vidéo
            function hideLoader() {
              if (loadingDiv) {
                loadingDiv.style.display = 'none';
              }
              if (errorDiv) {
                errorDiv.style.display = 'none';
              }
            }
            
            // Fonction pour afficher l'erreur
            function showError() {
              if (errorShown) return;
              errorShown = true;
              if (loadingDiv) loadingDiv.style.display = 'none';
              if (errorDiv) errorDiv.style.display = 'block';
            }
            
            // Vérifier que l'iframe se charge correctement
            function checkIframeLoad() {
              // Pour Safari mobile, timeout plus long (4 secondes) car le chargement peut être plus lent
              const timeoutDuration = isSafariMobile ? 4000 : 3000;
              
              loadCheckTimeout = setTimeout(function() {
                if (!hasLoaded) {
                  console.warn('Timeout de chargement après ' + timeoutDuration + 'ms');
                  // Sur Safari mobile, on masque le loader mais on n'affiche pas d'erreur immédiatement
                  // car l'iframe peut être chargée mais la vidéo ne joue pas à cause de l'autoplay bloqué
                  if (isSafariMobile) {
                    // Masquer le loader, la vidéo est probablement chargée mais en pause
                    hideLoader();
                    console.log('Safari mobile: Iframe chargée, autoplay peut être bloqué');
                  } else {
                    showError();
                  }
                }
              }, timeoutDuration);
            }
            
            // Écouter l'événement load de l'iframe
            iframe.addEventListener('load', function() {
              hasLoaded = true;
              clearTimeout(loadCheckTimeout);
              console.log('✅ Iframe chargée avec succès');
              
              // Masquer le loader immédiatement après le load
              hideLoader();
              
              // Pour Safari mobile, attendre un peu plus pour voir si la vidéo démarre
              if (isSafariMobile) {
                // Sur Safari, même si l'iframe charge, l'autoplay peut être bloqué
                // On masque le loader et on laisse l'utilisateur interagir
                setTimeout(function() {
                  console.log('Safari mobile: Vidéo prête (autoplay peut nécessiter interaction)');
                }, 500);
              }
            });
            
            // Écouter les erreurs
            iframe.addEventListener('error', function() {
              console.error('❌ Erreur de chargement de l\'iframe');
              showError();
            });
            
            // Fonction de retry
            window.retryVideoLoad = function(videoId, youtubeId) {
              errorShown = false;
              hasLoaded = false;
              if (loadingDiv) loadingDiv.style.display = 'flex';
              if (errorDiv) errorDiv.style.display = 'none';
              
              const muteParam = isSafariMobile ? '1' : '0';
              const baseUrl = '<%= request.base_url %>';
              const newUrl = 'https://www.youtube.com/embed/' + youtubeId + 
                '?autoplay=1' +
                '&controls=0' +
                '&modestbranding=1' +
                '&rel=0' +
                '&playsinline=1' +
                '&fs=1' +
                '&disablekb=1' +
                '&iv_load_policy=3' +
                '&cc_load_policy=0' +
                '&mute=' + muteParam +
                '&loop=0' +
                '&showinfo=0' +
                '&enablejsapi=1' +
                '&origin=' + encodeURIComponent(baseUrl) +
                '&t=' + Date.now(); // Cache buster
              
              iframe.src = '';
              setTimeout(function() {
                iframe.src = newUrl;
                checkIframeLoad();
              }, 300);
            };
            
            // Démarrer la vérification
            checkIframeLoad();
            
            // Masquer le loader après 3 secondes max (fallback si l'event load ne se déclenche pas)
            setTimeout(function() {
              if (loadingDiv && loadingDiv.style.display !== 'none' && !hasLoaded) {
                // Si le loader est toujours visible après 3 secondes et l'event load ne s'est pas déclenché
                // On masque le loader quand même (la vidéo peut être chargée)
                console.log('Fallback: Masquage du loader après timeout');
                loadingDiv.style.display = 'none';
              }
            }, 3000);
          })();
        </script>
      </div>

      <!-- Contrôles et informations -->
      <div class="shorts-controls">
        <div class="shorts-info">
          <h2><%= @game.current_video.title %></h2>
          <p><%= @playlist.title %></p>
        </div>
        
        <div class="shorts-actions">
          <%= button_to swipe_playlist_game_path(@playlist, @game, direction: "dislike"), 
              method: :post, 
              class: "action-btn dislike" do %>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="action-icon">
              <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          <% end %>
          
          <%= button_to swipe_playlist_game_path(@playlist, @game, direction: "like"), 
              method: :post, 
              class: "action-btn like" do %>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="action-icon">
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <div class="shorts-end">
      <div class="end-message">
        <h2>Playlist terminée !</h2>
        <%= link_to "Retour aux playlists", playlists_path, class: "end-button" %>
      </div>
    </div>
  <% end %>
</div>
