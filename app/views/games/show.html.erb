<div class="shorts-container">
  <% if @game.current_video %>
    <div class="shorts-player" id="game-swipe-player"
         data-swipe-video-id="<%= @game.current_video.id %>"
         data-swipe-playlist-id="<%= @playlist.id %>"
         data-swipe-game-id="<%= @game.id %>">
      <!-- Vid√©o -->
      <div class="shorts-video">
        <div id="video-container-<%= @game.current_video.id %>" style="width: 100%; height: 100%; position: relative;">
          <% 
            # D√©tection Safari mobile c√¥t√© serveur
            # Uniquement en production, pour √©viter les faux positifs en dev (Chrome + √©mulation iPhone)
            ua = request.user_agent.to_s
            is_safari_mobile = Rails.env.production? && ua.match?(/iPhone|iPad|iPod/) && ua.include?("Safari") && !ua.match?(/CriOS|Chrome/)
            
            # Pour Safari mobile, ne pas charger l'iframe directement (sera charg√©e apr√®s interaction)
            if is_safari_mobile
              video_url = "" # Vide pour Safari mobile - sera charg√©e apr√®s clic
            else
              base_url = request.base_url
              video_url = "https://www.youtube.com/embed/#{@game.current_video.youtube_id}?autoplay=1&controls=0&modestbranding=1&rel=0&playsinline=1&fs=1&disablekb=1&iv_load_policy=3&cc_load_policy=0&mute=0&loop=0&showinfo=0&enablejsapi=1&origin=#{CGI.escape(base_url)}"
            end
          %>
          <% if is_safari_mobile %>
          <!-- Option B : 1 tap = lecture imm√©diate (muet) via API YouTube -->
          <div id="game-yt-player-host" style="position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: calc(100vh - 120px) !important; z-index: 1 !important; transform: scale(2.2) !important; transform-origin: center center !important; background: #000 !important; display: none;"></div>
          <iframe id="youtube-player-<%= @game.current_video.id %>" src="" style="display: none;" title="YouTube"></iframe>
          <% else %>
          <iframe 
            id="youtube-player-<%= @game.current_video.id %>"
            src="<%= video_url %>"
            title="YouTube video player"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen="true"
            style="width: 100vw !important; height: calc(100vh - 120px) !important; position: fixed !important; top: 0 !important; left: 0 !important; border: none !important; pointer-events: none !important; z-index: 1 !important; transform: scale(2.2) !important; transform-origin: center center !important; object-fit: cover !important;">
          </iframe>
          <% end %>
          
          <!-- Option B : 1 tap = lancer (muet) ; bouton ¬´ Activer le son ¬ª bien visible -->
          <% if is_safari_mobile %>
          <div id="video-play-button-<%= @game.current_video.id %>" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 10000001; display: flex; align-items: center; justify-content: center; flex-direction: column; touch-action: manipulation;">
            <div style="color: white; text-align: center; padding: 20px;">
              <button type="button" id="safari-play-btn-<%= @game.current_video.id %>" style="background: #ff0000; color: white; border: none; padding: 20px 40px; border-radius: 50%; cursor: pointer; font-size: 24px; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(255,0,0,0.5); z-index: 10000002; position: relative; touch-action: manipulation;">
                ‚ñ∂
              </button>
              <p style="margin-top: 20px; font-size: 16px;">Appuyez pour lancer la vid√©o</p>
            </div>
          </div>
          <button type="button" id="game-sound-btn" style="display: none; position: fixed; top: 16px; right: 16px; z-index: 10000003; background: rgba(0,0,0,0.75); color: white; border: 2px solid rgba(255,255,255,0.9); padding: 12px 18px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; touch-action: manipulation; box-shadow: 0 2px 12px rgba(0,0,0,0.4);">üîä Activer le son</button>
          <% else %>
          <!-- Overlay de chargement pour autres navigateurs -->
          <div id="video-loading-<%= @game.current_video.id %>" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5; display: flex; align-items: center; justify-content: center; flex-direction: column;">
            <div style="color: white; text-align: center; padding: 20px;">
              <p style="margin-bottom: 20px; font-size: 18px;">Chargement de la vid√©o...</p>
              <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
          </div>
          <% end %>
          
          <!-- Message d'erreur avec bouton de retry et fallback -->
          <div id="video-error-<%= @game.current_video.id %>" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; background: rgba(0,0,0,0.9); padding: 30px; border-radius: 15px; color: white; text-align: center; max-width: 90%;">
            <p style="margin-bottom: 20px; font-size: 16px;">La vid√©o ne se charge pas</p>
            <button onclick="retryVideoLoad('<%= @game.current_video.id %>', '<%= @game.current_video.youtube_id %>')" style="background: #9333ea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin: 5px;">R√©essayer</button>
            <a href="https://www.youtube.com/watch?v=<%= @game.current_video.youtube_id %>" target="_blank" style="display: inline-block; background: #ff0000; color: white; border: none; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-size: 16px; font-weight: bold; margin: 5px;">Ouvrir sur YouTube</a>
            <p style="margin-top: 15px; font-size: 12px; opacity: 0.7;">Si le probl√®me persiste, essayez de rafra√Æchir la page</p>
          </div>
        </div>
        
        <style>
          @keyframes spin {
            to { transform: rotate(360deg); }
          }
          #game-yt-player-host iframe {
            width: 100% !important;
            height: 100% !important;
            border: none !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
          }
        </style>
        
        <script>
          (function() {
            const videoId = '<%= @game.current_video.id %>';
            const youtubeId = '<%= @game.current_video.youtube_id %>';
            const iframe = document.getElementById('youtube-player-' + videoId);
            const loadingDiv = document.getElementById('video-loading-' + videoId);
            const errorDiv = document.getElementById('video-error-' + videoId);
            
            if (!iframe) return;
            
            // D√©tection Safari mobile
            const isSafariMobile = /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            let loadCheckTimeout;
            let hasLoaded = false;
            let errorShown = false;
            
            // Fonction pour masquer le loader et afficher la vid√©o
            function hideLoader() {
              if (loadingDiv) {
                loadingDiv.style.display = 'none';
              }
              if (errorDiv) {
                errorDiv.style.display = 'none';
              }
            }
            
            // Fonction pour afficher l'erreur
            function showError() {
              if (errorShown) return;
              errorShown = true;
              if (loadingDiv) loadingDiv.style.display = 'none';
              if (errorDiv) errorDiv.style.display = 'block';
            }
            
            // V√©rifier que l'iframe se charge correctement
            function checkIframeLoad() {
              // Pour Safari mobile, timeout plus long (5 secondes) car le chargement peut √™tre plus lent
              const timeoutDuration = isSafariMobile ? 5000 : 3000;
              
              loadCheckTimeout = setTimeout(function() {
                if (!hasLoaded) {
                  console.warn('Timeout de chargement apr√®s ' + timeoutDuration + 'ms');
                  // Afficher l'erreur apr√®s le timeout
                  showError();
                }
              }, timeoutDuration);
            }
            
            // √âcouter l'√©v√©nement load de l'iframe
            iframe.addEventListener('load', function() {
              hasLoaded = true;
              clearTimeout(loadCheckTimeout);
              console.log('‚úÖ Iframe charg√©e avec succ√®s');
              
              // Masquer le loader imm√©diatement apr√®s le load
              hideLoader();
              
              // Pour Safari mobile, attendre un peu plus pour voir si la vid√©o d√©marre
              if (isSafariMobile) {
                // Sur Safari, m√™me si l'iframe charge, l'autoplay peut √™tre bloqu√©
                // On masque le loader et on laisse l'utilisateur interagir
                setTimeout(function() {
                  console.log('Safari mobile: Vid√©o pr√™te (autoplay peut n√©cessiter interaction)');
                }, 500);
              }
            });
            
            // √âcouter les erreurs
            iframe.addEventListener('error', function() {
              console.error('‚ùå Erreur de chargement de l\'iframe');
              showError();
            });
            
            // Option B (Safari) : 1 tap = lecture imm√©diate (muet), bouton "Activer le son"
            window.gameYtPlayer = null;
            window.loadVideoOnSafari = function(videoId, youtubeId) {
              var playButton = document.getElementById('video-play-button-' + videoId) || document.querySelector('[id^="video-play-button-"]');
              if (playButton) playButton.style.display = 'none';
              var host = document.getElementById('game-yt-player-host');
              if (!host) return;
              host.style.display = 'block';
              var sonBtn = document.getElementById('game-sound-btn');
              function showSoundBtn() {
                if (sonBtn) {
                  sonBtn.style.display = 'block';
                  sonBtn.textContent = 'üîä Activer le son';
                  sonBtn.style.opacity = '1';
                }
              }
              var hadPlayer = !!window.gameYtPlayer;
              if (window.gameYtPlayer && host) {
                host.innerHTML = '';
                window.gameYtPlayer = null;
              }
              window.pendingYtPlay = { videoId: videoId, youtubeId: youtubeId, playButton: playButton };
              if (!window.YT || !window.YT.Player) {
                var tag = document.createElement('script');
                tag.src = 'https://www.youtube.com/iframe_api';
                document.getElementsByTagName('script')[0].parentNode.insertBefore(tag, document.getElementsByTagName('script')[0]);
              }
              var checkReady = function() {
                if (window.YT && window.YT.Player && window.pendingYtPlay) {
                  var p = window.pendingYtPlay;
                  var hostEl = document.getElementById('game-yt-player-host');
                  if (!hostEl) return;
                  if (hostEl.children.length > 0) hostEl.innerHTML = '';
                  window.gameYtPlayer = new YT.Player('game-yt-player-host', {
                    width: '100%',
                    height: '100%',
                    videoId: p.youtubeId,
                    playerVars: { autoplay: 1, mute: 1, playsinline: 1, controls: 0, rel: 0, modestbranding: 1 },
                    events: {
                      onReady: function(e) {
                        e.target.playVideo();
                        window.pendingYtPlay = null;
                        showSoundBtn();
                      }
                    }
                  });
                } else if (window.pendingYtPlay) {
                  setTimeout(checkReady, 100);
                }
              };
              if (window.YT && window.YT.Player) {
                if (hadPlayer) {
                  setTimeout(checkReady, 50);
                } else {
                  checkReady();
                }
              } else {
                window.onYouTubeIframeAPIReady = function() { checkReady(); };
                setTimeout(checkReady, 500);
              }
            };
            var playBtn = document.getElementById('safari-play-btn-' + videoId);
            if (playBtn && isSafariMobile) {
              function doPlay(e) {
                if (e) { e.preventDefault(); e.stopPropagation(); }
                window.loadVideoOnSafari(videoId, youtubeId);
              }
              playBtn.addEventListener('click', function(e) { e.preventDefault(); doPlay(e); });
              playBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                e.stopPropagation();
                doPlay(e);
              }, { passive: false });
            }
            var soundBtn = document.getElementById('game-sound-btn');
            if (soundBtn && isSafariMobile) {
              function unmute() {
                soundBtn.textContent = '‚úì Son activ√©';
                soundBtn.style.opacity = '0.8';
                if (window.gameYtPlayer) {
                  try {
                    if (typeof window.gameYtPlayer.unMute === 'function') {
                      window.gameYtPlayer.unMute();
                    }
                    if (typeof window.gameYtPlayer.setVolume === 'function') {
                      window.gameYtPlayer.setVolume(100);
                    }
                  } catch (err) {}
                }
                var isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
                if (isIOS) {
                  var oldTip = document.getElementById('game-sound-tip');
                  if (oldTip) oldTip.remove();
                  var tip = document.createElement('div');
                  tip.id = 'game-sound-tip';
                  tip.style.cssText = 'position: fixed; bottom: 240px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 12px 20px; border-radius: 10px; font-size: 14px; z-index: 10000004; max-width: 90%; text-align: center; pointer-events: none;';
                  tip.textContent = 'Si le son ne s\'active pas, touchez la vid√©o.';
                  document.body.appendChild(tip);
                  setTimeout(function() { if (tip.parentNode) tip.remove(); }, 4000);
                }
              }
              soundBtn.addEventListener('click', function(e) { e.preventDefault(); unmute(); });
              soundBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                e.stopPropagation();
                unmute();
              }, { passive: false });
            }
            
            // Fonction de retry
            window.retryVideoLoad = function(videoId, youtubeId) {
              errorShown = false;
              hasLoaded = false;
              if (loadingDiv) loadingDiv.style.display = 'flex';
              if (errorDiv) errorDiv.style.display = 'none';
              
              // Pour Safari mobile, URL simplifi√©e sans origin
              let newUrl;
              if (isSafariMobile) {
                newUrl = 'https://www.youtube.com/embed/' + youtubeId + 
                  '?autoplay=1' +
                  '&mute=0' +
                  '&playsinline=1' +
                  '&controls=0' +
                  '&rel=0' +
                  '&modestbranding=1' +
                  '&t=' + Date.now();
              } else {
                const baseUrl = '<%= request.base_url %>';
                newUrl = 'https://www.youtube.com/embed/' + youtubeId + 
                  '?autoplay=1' +
                  '&controls=0' +
                  '&modestbranding=1' +
                  '&rel=0' +
                  '&playsinline=1' +
                  '&fs=1' +
                  '&disablekb=1' +
                  '&iv_load_policy=3' +
                  '&cc_load_policy=0' +
                  '&mute=0' +
                  '&loop=0' +
                  '&showinfo=0' +
                  '&enablejsapi=1' +
                  '&origin=' + encodeURIComponent(baseUrl) +
                  '&t=' + Date.now();
              }
              
              iframe.src = '';
              setTimeout(function() {
                iframe.src = newUrl;
                checkIframeLoad();
              }, 500);
            };
            
            // D√©marrer la v√©rification seulement si ce n'est pas Safari mobile (iframe d√©j√† charg√©e)
            if (!isSafariMobile) {
              checkIframeLoad();
              
              // Masquer le loader apr√®s 3 secondes max (fallback si l'event load ne se d√©clenche pas)
              setTimeout(function() {
                if (loadingDiv && loadingDiv.style.display !== 'none' && !hasLoaded) {
                  // Si le loader est toujours visible apr√®s 3 secondes et l'event load ne s'est pas d√©clench√©
                  // On masque le loader quand m√™me (la vid√©o peut √™tre charg√©e)
                  console.log('Fallback: Masquage du loader apr√®s timeout');
                  loadingDiv.style.display = 'none';
                }
              }, 3000);
            }
          })();
        </script>
      </div>

      <!-- Zone cliquable en bas : bloque les clics √† l'iframe pour que Like/Dislike re√ßoivent les touches -->
      <div class="shorts-controls-zone" id="game-controls-zone" style="position: fixed !important; bottom: 0 !important; left: 0 !important; right: 0 !important; height: 220px !important; z-index: 2147483646 !important; pointer-events: auto !important; touch-action: manipulation !important;"></div>
      <!-- Contr√¥les et informations -->
      <div class="shorts-controls">
        <div class="shorts-actions">
          <button type="button" class="action-btn dislike" id="game-btn-dislike" onclick="if(window.gameSwipeDislike){window.gameSwipeDislike();} return false;" ontouchend="if(window.gameSwipeDislike){event.preventDefault();window.gameSwipeDislike();} return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="action-icon">
              <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <button type="button" class="action-btn like" id="game-btn-like" onclick="if(window.gameSwipeLike){window.gameSwipeLike();} return false;" ontouchend="if(window.gameSwipeLike){event.preventDefault();window.gameSwipeLike();} return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="action-icon">
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
          </button>
        </div>

        <div class="shorts-info">
          <h2><%= @game.current_video.title %></h2>
          <p><%= @playlist.title %></p>
        </div>
      </div>
    </div>

    <script>
    (function() {
      function initGameSwipe() {
        var player = document.getElementById('game-swipe-player');
        if (!player) { console.warn('[Game] game-swipe-player non trouv√©'); return; }

        var isProcessing = false;

      function getData() {
        return {
          videoId: player.getAttribute('data-swipe-video-id'),
          playlistId: player.getAttribute('data-swipe-playlist-id'),
          gameId: player.getAttribute('data-swipe-game-id')
        };
      }

      function setButtonsEnabled(enabled) {
        var btns = player.querySelectorAll('.action-btn');
        btns.forEach(function(btn) {
          btn.disabled = !enabled;
          btn.style.opacity = enabled ? '1' : '0.5';
        });
      }

      function handleSwipe(liked) {
        if (isProcessing) return;
        var d = getData();
        if (!d.videoId || !d.playlistId || !d.gameId) {
          alert('Donn√©es manquantes. Rechargez la page.');
          return;
        }
        isProcessing = true;
        setButtonsEnabled(false);

        var csrf = document.querySelector('meta[name="csrf-token"]');
        var token = csrf ? csrf.getAttribute('content') : '';

        fetch('/swipes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': token,
            'Accept': 'application/json'
          },
          credentials: 'same-origin',
          body: JSON.stringify({
            video_id: d.videoId,
            playlist_id: d.playlistId,
            game_id: d.gameId,
            liked: liked
          })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (!data.success) {
            if (data.redirect) window.location.href = data.redirect;
            else { isProcessing = false; setButtonsEnabled(true); alert(data.error || 'Erreur'); }
            return;
          }
          if (data.completed) {
            window.location.href = data.redirect || '/playlists/' + d.playlistId + '/games/' + d.gameId + '/results';
            return;
          }
          if (data.next_video_id && data.next_video_youtube_id) {
            var isSafari = /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
            player.setAttribute('data-swipe-video-id', String(data.next_video_id));
            var titleEl = document.querySelector('.shorts-info h2');
            if (titleEl && data.next_video_title) titleEl.textContent = data.next_video_title;

            if (isSafari && typeof window.loadVideoOnSafari === 'function') {
              // Vid√©o suivante avec son (iframe) ; si iOS bloque l'autoplay, l'utilisateur tape sur le Play YouTube
              window.loadVideoOnSafari(data.next_video_id, data.next_video_youtube_id);
            } else {
              var iframe = document.querySelector('iframe[id^="youtube-player-"]');
              if (iframe) {
                var base = window.location.origin;
                iframe.src = 'https://www.youtube.com/embed/' + data.next_video_youtube_id +
                  '?autoplay=1&controls=0&modestbranding=1&rel=0&playsinline=1&fs=1&disablekb=1' +
                  '&iv_load_policy=3&cc_load_policy=0&mute=0&showinfo=0&enablejsapi=1&origin=' + encodeURIComponent(base);
              } else {
                window.location.href = data.redirect || '/playlists/' + d.playlistId + '/games/' + d.gameId;
                return;
              }
            }
            isProcessing = false;
            setButtonsEnabled(true);
          } else {
            window.location.href = data.redirect || '/playlists/' + d.playlistId + '/games/' + d.gameId;
          }
        })
        .catch(function(err) {
          console.error('Swipe error:', err);
          isProcessing = false;
          setButtonsEnabled(true);
          alert('Erreur de connexion. R√©essayez.');
        });
      }

        // Exposer les fonctions globales pour les onclick/ontouchend inline (fallback fiable)
        window.gameSwipeLike = function() { handleSwipe(true); };
        window.gameSwipeDislike = function() { handleSwipe(false); };

        // Handlers directs sur les boutons
        var btnLike = document.getElementById('game-btn-like');
        var btnDislike = document.getElementById('game-btn-dislike');
        function bindButton(btn, liked) {
          if (!btn) return;
          function doSwipe(e) {
            if (e) { e.preventDefault(); e.stopPropagation(); }
            handleSwipe(liked);
          }
          btn.onclick = doSwipe;
          btn.ontouchend = function(e) {
            e.preventDefault();
            e.stopPropagation();
            handleSwipe(liked);
          };
        }
        bindButton(btnLike, true);
        bindButton(btnDislike, false);
        console.log('[Game] Like/Dislike initialis√©s (boutons:', !!btnLike, !!btnDislike, ')');

        // Capture au niveau document en secours (zone contr√¥le pour ne pas donner le focus √† l'iframe)
        function onPlayerClick(e) {
          var zone = document.getElementById('game-controls-zone');
          if (zone && zone.contains(e.target)) {
            e.preventDefault();
            e.stopPropagation();
          }
        }
        document.addEventListener('click', onPlayerClick, true);
        document.addEventListener('touchend', onPlayerClick, true);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initGameSwipe);
      } else {
        initGameSwipe();
      }
    })();
    </script>
  <% else %>
    <div class="shorts-end">
      <div class="end-message">
        <h2>Playlist termin√©e !</h2>
        <%= link_to "Retour aux playlists", playlists_path, class: "end-button" %>
      </div>
    </div>
  <% end %>
</div>
