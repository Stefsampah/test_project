<div class="shorts-container">
  <% if @game.current_video %>
    <div class="shorts-player">
      <!-- Vidéo -->
      <div class="shorts-video">
        <div id="video-container-<%= @game.current_video.id %>" style="width: 100%; height: 100%; position: relative;">
          <iframe 
            id="youtube-player-<%= @game.current_video.id %>"
            src=""
            title="YouTube video player"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen="true"
            style="width: 100vw !important; height: calc(100vh - 120px) !important; position: fixed !important; top: 0 !important; left: 0 !important; border: none !important; pointer-events: auto !important; z-index: 1 !important; transform: scale(2.2) !important; transform-origin: center center !important; object-fit: cover !important;">
          </iframe>
          <div id="video-error-<%= @game.current_video.id %>" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; color: white; text-align: center;">
            <p style="margin-bottom: 15px;">La vidéo ne se charge pas</p>
            <button onclick="retryVideoLoad('<%= @game.current_video.id %>', '<%= @game.current_video.youtube_id %>')" style="background: #9333ea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Réessayer</button>
          </div>
        </div>
        <script>
          // Détection Safari mobile
          const isSafariMobile = /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
          
          // Fonction pour charger la vidéo avec les bons paramètres
          function loadYouTubeVideo(videoId, youtubeId) {
            const iframe = document.getElementById('youtube-player-' + videoId);
            const errorDiv = document.getElementById('video-error-' + videoId);
            if (!iframe) return;
            
            // Pour Safari mobile, utiliser mute=1 pour permettre l'autoplay
            const muteParam = isSafariMobile ? '1' : '0';
            const baseUrl = '<%= request.base_url %>';
            
            const videoUrl = 'https://www.youtube.com/embed/' + youtubeId + 
              '?autoplay=1' +
              '&controls=0' +
              '&modestbranding=1' +
              '&rel=0' +
              '&playsinline=1' +
              '&fs=1' +
              '&disablekb=1' +
              '&iv_load_policy=3' +
              '&cc_load_policy=0' +
              '&mute=' + muteParam +
              '&loop=0' +
              '&showinfo=0' +
              '&enablejsapi=1' +
              '&origin=' + encodeURIComponent(baseUrl);
            
            iframe.src = videoUrl;
            errorDiv.style.display = 'none';
            
            // Détecter les erreurs de chargement
            let loadTimeout;
            let hasLoaded = false;
            
            const checkLoad = function() {
              if (!hasLoaded) {
                // Vérifier si l'iframe a chargé après 3 secondes
                loadTimeout = setTimeout(function() {
                  if (!hasLoaded) {
                    console.warn('Timeout de chargement de la vidéo');
                    errorDiv.style.display = 'block';
                  }
                }, 3000);
              }
            };
            
            iframe.addEventListener('load', function() {
              hasLoaded = true;
              clearTimeout(loadTimeout);
              console.log('Vidéo chargée avec succès');
              errorDiv.style.display = 'none';
            });
            
            iframe.addEventListener('error', function() {
              console.error('Erreur de chargement de la vidéo');
              errorDiv.style.display = 'block';
            });
            
            // Démarrer la vérification
            checkLoad();
          }
          
          // Fonction pour réessayer le chargement
          function retryVideoLoad(videoId, youtubeId) {
            const iframe = document.getElementById('youtube-player-' + videoId);
            if (iframe) {
              iframe.src = '';
              setTimeout(function() {
                loadYouTubeVideo(videoId, youtubeId);
              }, 500);
            }
          }
          
          // Charger la vidéo au chargement de la page
          (function() {
            const videoId = '<%= @game.current_video.id %>';
            const youtubeId = '<%= @game.current_video.youtube_id %>';
            
            // Attendre que le DOM soit prêt
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', function() {
                loadYouTubeVideo(videoId, youtubeId);
              });
            } else {
              loadYouTubeVideo(videoId, youtubeId);
            }
          })();
        </script>
      </div>

      <!-- Contrôles et informations -->
      <div class="shorts-controls">
        <div class="shorts-info">
          <h2><%= @game.current_video.title %></h2>
          <p><%= @playlist.title %></p>
        </div>
        
        <div class="shorts-actions">
          <%= button_to swipe_playlist_game_path(@playlist, @game, direction: "dislike"), 
              method: :post, 
              class: "action-btn dislike" do %>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="action-icon">
              <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          <% end %>
          
          <%= button_to swipe_playlist_game_path(@playlist, @game, direction: "like"), 
              method: :post, 
              class: "action-btn like" do %>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="action-icon">
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <div class="shorts-end">
      <div class="end-message">
        <h2>Playlist terminée !</h2>
        <%= link_to "Retour aux playlists", playlists_path, class: "end-button" %>
      </div>
    </div>
  <% end %>
</div>
