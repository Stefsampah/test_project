<div class="shorts-container">
  <% if @game.current_video %>
    <div class="shorts-player">
      <!-- Vidéo -->
      <div class="shorts-video">
        <iframe 
          id="youtube-player-<%= @game.current_video.id %>"
          src="https://www.youtube.com/embed/<%= @game.current_video.youtube_id %>?autoplay=1&controls=0&modestbranding=1&rel=0&playsinline=1&fs=1&disablekb=1&iv_load_policy=3&cc_load_policy=0&mute=0&loop=0&showinfo=0&enablejsapi=1&origin=<%= request.base_url %>"
          title="YouTube video player"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen="true"
          style="width: 100vw !important; height: calc(100vh - 120px) !important; position: fixed !important; top: 0 !important; left: 0 !important; border: none !important; pointer-events: auto !important; z-index: 1 !important; transform: scale(2.2) !important; transform-origin: center center !important; object-fit: cover !important;">
        </iframe>
        <script>
          // Gestion des erreurs de lecture vidéo sur mobile
          (function() {
            const iframe = document.getElementById('youtube-player-<%= @game.current_video.id %>');
            if (!iframe) return;
            
            let errorCount = 0;
            const maxRetries = 2;
            
            // Détecter les erreurs de chargement
            iframe.addEventListener('load', function() {
              errorCount = 0;
              console.log('Vidéo chargée avec succès');
            });
            
            // Tentative de détection d'erreur via timeout
            const loadTimeout = setTimeout(function() {
              if (errorCount === 0) {
                console.warn('Timeout de chargement de la vidéo');
                // Essayer de recharger la vidéo une fois
                if (errorCount < maxRetries) {
                  errorCount++;
                  const currentSrc = iframe.src;
                  iframe.src = '';
                  setTimeout(function() {
                    iframe.src = currentSrc;
                  }, 500);
                }
              }
            }, 5000);
            
            // Nettoyer le timeout si la vidéo charge correctement
            iframe.addEventListener('load', function() {
              clearTimeout(loadTimeout);
            });
          })();
        </script>
      </div>

      <!-- Contrôles et informations -->
      <div class="shorts-controls">
        <div class="shorts-info">
          <h2><%= @game.current_video.title %></h2>
          <p><%= @playlist.title %></p>
        </div>
        
        <div class="shorts-actions">
          <%= button_to swipe_playlist_game_path(@playlist, @game, direction: "dislike"), 
              method: :post, 
              class: "action-btn dislike" do %>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="action-icon">
              <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          <% end %>
          
          <%= button_to swipe_playlist_game_path(@playlist, @game, direction: "like"), 
              method: :post, 
              class: "action-btn like" do %>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="action-icon">
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <div class="shorts-end">
      <div class="end-message">
        <h2>Playlist terminée !</h2>
        <%= link_to "Retour aux playlists", playlists_path, class: "end-button" %>
      </div>
    </div>
  <% end %>
</div>
