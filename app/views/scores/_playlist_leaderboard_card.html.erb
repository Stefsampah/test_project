<%
image_variations = [
  playlist.title + '.jpg',
  playlist.title.parameterize.underscore + '.jpg',
  playlist.title.downcase.gsub(' ', '_') + '.jpg',
  playlist.title.parameterize.underscore.gsub('afropop', 'afro_pop') + '.jpg',
  playlist.title.parameterize.underscore.gsub('of_', '') + '.jpg'
]
found_image = nil
image_variations.each do |img_name|
  if File.exist?(Rails.root.join('app', 'assets', 'images', 'playlists', img_name))
    found_image = img_name
    break
  end
end
cover_url = found_image ? asset_path("playlists/#{found_image}") : asset_path('playlists/This is Pop.jpg')
%>
<div class="playlist-card group relative rounded-3xl overflow-hidden shadow-2xl transition-all duration-300 hover:scale-105 h-80 flex flex-col">
  <!-- Partie haute : image de fond (40%) -->
  <div class="relative" style="flex-basis: 40%; background-image: url('<%= cover_url %>'); background-size: cover; background-position: center;">
    <div class="absolute inset-0 bg-black bg-opacity-40"></div>
    <div class="relative z-10 flex items-end h-full p-4">
      <h3 class="text-2xl font-bold text-white"><%= playlist.title %></h3>
    </div>
  </div>
  <!-- Partie basse : fond uni (60%) -->
  <div class="relative flex-1 flex flex-col justify-between bg-gray-900 p-6" style="flex-basis: 60%;">
    <div class="w-full">
      <h4 class="text-white text-lg font-semibold mb-2">Top Players</h4>
      <% top_scores_by_user = scores.group_by(&:user_id).map { |user_id, user_scores| user_scores.max_by(&:points) }.sort_by { |s| -s.points } %>
      <% top_scores_by_user.first(3).each_with_index do |score, idx| %>
        <% user = score.user %>
        <div class="flex items-center justify-between bg-black bg-opacity-40 rounded-xl px-3 py-2 mb-2">
          <div class="flex items-center gap-3">
            <span class="inline-block w-8 h-8 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-lg font-bold text-white shadow">
              <% if user.avatar.attached? %>
                <%= image_tag user.avatar, class: "h-8 w-8 rounded-full object-cover" %>
              <% else %>
                <span><%= user.email.first.upcase %></span>
              <% end %>
            </span>
            <span class="text-white font-semibold truncate max-w-[100px]"> <%= user.email %> </span>
          </div>
          <span class="text-xl font-extrabold text-yellow-300"><%= score.points %></span>
        </div>
      <% end %>
    </div>
    <div class="w-full flex justify-center mt-4">
      <% if should_disable_actions? %>
        <div class="px-6 py-2 rounded-full bg-gray-600 text-gray-300 text-lg font-bold w-full text-center cursor-not-allowed" style="opacity: 0.6;">
          Partie en cours
        </div>
      <% else %>
        <%= link_to "Jouer la playlist", new_playlist_game_path_with_locale(playlist), class: "px-6 py-2 rounded-full bg-yellow-400 text-black text-lg font-bold shadow-lg hover:bg-yellow-300 transition w-full text-center" %>
      <% end %>
    </div>
  </div>
  <% unless should_disable_actions? %>
    <%= link_to '', new_playlist_game_path_with_locale(playlist), class: 'absolute inset-0 z-20', style: 'pointer-events: auto;' %>
  <% end %>
</div> 