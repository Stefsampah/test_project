<% require 'ostruct' %>
<!-- Section des scores totaux -->
<div class="min-h-screen bg-gray-900 py-6 sm:py-10">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- En-tÃªte avec logo -->
    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-gray-800 rounded-full flex items-center justify-center">
          <div class="w-6 h-6 text-cyan-400">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5.14v14l11-7-11-7z"/>
            </svg>
          </div>
        </div>
        <h1 class="text-3xl font-bold text-white ml-4">Classements</h1>
      </div>
      
      <!-- Filtres -->
      <div class="hidden sm:flex space-x-2">
        <button class="score-filter active px-3 py-1 rounded-full text-sm font-medium text-white bg-gray-800 hover:bg-gray-700 transition-colors" data-target="all">Toutes les scores</button>
        <button class="score-filter px-3 py-1 rounded-full text-sm font-medium text-white bg-gray-800 hover:bg-gray-700 transition-colors" data-target="my">Mes scores</button>
      </div>
    </div>
    
    <!-- Filtres mobile -->
    <div class="sm:hidden flex flex-wrap justify-center gap-2 mb-6">
      <button class="score-filter active px-3 py-1 rounded-full text-sm font-medium text-white bg-gray-800 hover:bg-gray-700 transition-colors" data-target="all">Toutes les scores</button>
      <button class="score-filter px-3 py-1 rounded-full text-sm font-medium text-white bg-gray-800 hover:bg-gray-700 transition-colors" data-target="my">Mes scores</button>
    </div>

    <!-- Section scores totaux -->
    <div id="total-section" class="score-section">
      <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-lg p-6 mb-8 shadow-lg">
        <h2 class="text-2xl font-semibold text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-2 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
          </svg>
          Top Players
        </h2>
        
        <div class="flex flex-col md:flex-row md:space-x-6 mb-8 justify-center items-end">
          <% if @total_scores.present? %>
            <% @total_scores.first(3).each_with_index do |score, index| %>
              <% user = User.find(score[:user_id]) rescue nil %>
              <% next unless user %>
              <% badge = user.badges.last rescue nil %>
              <% badge ||= { name: "Top engager du jour", badge_type: "engager", image: nil } %>
              <% points = score[:points].to_i %>
              <% next_rank = ((points / 100) + 1) * 100 %>
              <% progress = [[(points.to_f / next_rank * 100).round, 100].min, 0].max %>
              <div class="relative flex-1 flex flex-col items-center justify-center mb-6 md:mb-0">
                <!-- Avatar avec halo et effet de couronne pour le 1er -->
                <div class="relative mb-2 flex items-center justify-center">
                  <img src="/players/<%= user.id %>.jpg"
                       class="h-24 w-24 rounded-full border-4 border-yellow-400 shadow-xl z-10 object-cover halo-glow"
                       onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                  <% if user.avatar.attached? %>
                    <div class="rounded-full border-4 border-yellow-400 shadow-xl z-10 overflow-hidden relative halo-glow" style="display:none;">
                      <%= image_tag user.avatar, class: "h-24 w-24 object-cover" %>
                    </div>
                  <% else %>
                    <div class="h-24 w-24 rounded-full bg-gray-700 flex items-center justify-center border-4 border-yellow-400 shadow-xl z-10 halo-glow" style="display:none;">
                      <span class="text-white text-4xl font-bold"><%= user.email.first.upcase %></span>
                    </div>
                  <% end %>
                </div>
                <!-- Effets animÃ©s autour du pseudo -->
                <div class="relative flex items-center justify-center mb-1 pseudo-effects" style="min-height: 2.5rem;">
                  <span class="text-xl font-bold text-white z-10"><%= user.email.split('@').first %></span>
                  <% if points >= 100 %>
                    <span class="absolute -top-4 left-1/2 -translate-x-1/2 star-anim text-yellow-300 text-2xl">â˜…</span>
                  <% end %>
                  <% if points >= 50 %>
                    <span class="absolute -bottom-4 left-2 flame-anim text-orange-400 text-xl">ðŸ”¥</span>
                  <% end %>
                  <% if points >= 30 %>
                    <span class="absolute -top-2 right-0 spark-anim text-blue-400 text-xl">âœ¨</span>
                  <% end %>
                  <% if points >= 10 %>
                    <span class="absolute -bottom-2 right-2 bolt-anim text-red-400 text-lg">âš¡</span>
                  <% end %>
                </div>
                <!-- Badge dynamique -->
                <div class="flex flex-col items-center w-full">
                  <% if badge %>
                    <% 
                      # Personnalisation du nom du badge selon l'utilisateur
                      badge_name = case user.email.split('@').first.downcase
                        when 'driss' then 'Top ratio'
                        when 'theo' then 'Top critic'
                        else 'Top engager du jour'
                      end
                      
                      badge_color = case badge[:badge_type]
                        when "competitor" then 'bg-yellow-500 badge-anim'
                        when "engager" then 'bg-blue-500 badge-anim'
                        when "critic" then 'bg-red-500 badge-anim'
                        when "challenger" then 'bg-purple-500 badge-anim'
                        else 'bg-blue-500 badge-anim' end %>
                    <span class="inline-block px-3 py-1 rounded-full text-white text-xs font-semibold mb-1 <%= badge_color %>">
                      <%= badge_name %>
                    </span>
                  <% else %>
                    <span class="inline-block px-3 py-1 rounded-full bg-gray-500 text-white text-xs font-semibold mb-1">Aucun badge</span>
                  <% end %>
                  <span class="text-3xl font-extrabold text-yellow-300 mb-1"><%= score[:points] %></span>
                  <!-- Barre de progression -->
                  <div class="w-40 h-4 bg-gray-700 rounded-full overflow-hidden shadow-inner mb-2 border border-yellow-300">
                    <div class="h-full rounded-full transition-all duration-700" style="width: <%= progress %>%; background: linear-gradient(90deg, #FFD700, #FF9800, #FFEB3B);"></div>
                  </div>
                  <span class="text-xs text-gray-300">Prochain rang : <%= next_rank %> pts</span>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="text-center text-gray-400 py-8">
              <p>Aucun score disponible pour le moment.</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Section catÃ©gories spÃ©ciales moderne -->
    <div id="categories-section" class="score-section">
      <div class="flex flex-col md:flex-row gap-6 mb-8">
        <%= render partial: "leaderboard_section", locals: {
          title: "Meilleurs Engagements",
          icon: "ðŸ’¬",
          data: @top_engager_leaderboard,
          unit: ""
        } %>
        <%= render partial: "leaderboard_section", locals: {
          title: "Meilleurs Ratios",
          icon: "ðŸ“ˆ",
          data: @best_ratio_leaderboard,
          unit: "%"
        } %>
        <%= render partial: "leaderboard_section", locals: {
          title: "Meilleurs Critiques",
          icon: "â­",
          data: @wise_critic_leaderboard,
          unit: ""
        } %>
      </div>
    </div>

    <!-- Section scores par playlist -->
    <div id="playlists-section" class="score-section">
      <% if @scores_by_playlist.present? %>
        <% @scores_by_playlist.each_slice(3).each do |playlist_group| %>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-8">
            <% playlist_group.each do |playlist, scores| %>
              <%= render partial: "playlist_leaderboard_card", locals: { playlist: playlist, scores: scores } %>
            <% end %>
          </div>
        <% end %>
      <% else %>
        <div class="text-center text-gray-400 py-8">
          <p>Aucun score par playlist disponible.</p>
        </div>
      <% end %>
    </div>

    <!-- Section mes scores -->
    <div id="my-scores-section" class="score-section" style="display: none;">
      <div class="bg-gradient-to-r from-blue-800 to-blue-900 rounded-lg p-6 mb-8 shadow-lg">
        <h2 class="text-2xl font-semibold text-white mb-6 flex items-center">
          <svg class="w-6 h-6 mr-2 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Mes Scores
        </h2>
        
        <% if @my_scores.present? %>
          <!-- RÃ©sumÃ© des scores -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 rounded-lg p-4 text-center">
              <div class="text-3xl font-bold text-blue-400 mb-2"><%= @my_scores.count %></div>
              <div class="text-gray-300 text-sm">Playlists jouÃ©es</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 text-center">
              <div class="text-3xl font-bold text-green-400 mb-2"><%= @my_scores.sum(&:points) %></div>
              <div class="text-gray-300 text-sm">Points totaux</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 text-center">
              <div class="text-3xl font-bold text-yellow-400 mb-2"><%= @my_scores.maximum(:points) || 0 %></div>
              <div class="text-gray-300 text-sm">Meilleur score</div>
            </div>
          </div>

          <!-- Scores par playlist -->
          <div class="space-y-6">
            <% @my_scores_by_playlist.each do |playlist, scores| %>
              <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-xl font-semibold text-white"><%= playlist.title %></h3>
                  <span class="text-2xl font-bold text-blue-400"><%= scores.first.points %></span>
                </div>
                
                <div class="flex items-center justify-between text-sm text-gray-300">
                  <span>JouÃ© le <%= scores.first.updated_at.strftime("%d/%m/%Y") %></span>
                  <span><%= pluralize(playlist.videos.count, 'titre') %></span>
                </div>
                
                <% if playlist.genre.present? %>
                  <div class="mt-2">
                    <span class="inline-block bg-gray-700 text-blue-400 text-xs px-2 py-1 rounded">
                      <%= playlist.genre %>
                    </span>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center text-gray-400 py-8">
            <p>Vous n'avez pas encore de scores. Commencez Ã  jouer pour voir vos rÃ©sultats ici !</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Boutons animÃ©s sous le classement -->
<div class="flex flex-col md:flex-row justify-center items-center gap-4 my-8">
  <button class="play-btn px-8 py-4 rounded-full text-xl font-bold text-white bg-gradient-to-r from-orange-400 to-yellow-500 shadow-lg transition-transform duration-200 hover:scale-110 hover:animate-bounce focus:outline-none">
    ðŸŽ® Rejouer contre...
  </button>
  <button class="share-btn px-8 py-4 rounded-full text-xl font-bold text-white bg-gradient-to-r from-blue-500 to-cyan-400 shadow-lg transition-transform duration-200 hover:scale-110 sticker-anim focus:outline-none flex items-center gap-2">
    ðŸ“£ Partager mon classement
    <span class="inline-block animate-wiggle">âœ¨</span>
  </button>
</div>

<style>
  .score-filter.active {
    background-color: #4f46e5;
  }
  
  @keyframes gradient {
    0% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
    100% {
      background-position: 0% 50%;
    }
  }
  
  .score-section {
    transition: all 0.3s ease;
  }

  .halo-glow {
    box-shadow: 0 0 32px 8px #ffe066, 0 0 0 4px #fffbe6;
    animation: halo-pulse 2s infinite alternate;
  }
  @keyframes halo-pulse {
    0% { box-shadow: 0 0 32px 8px #ffe066, 0 0 0 4px #fffbe6; }
    100% { box-shadow: 0 0 48px 16px #ffd700, 0 0 0 8px #fffbe6; }
  }
  .animate-spin-slow {
    animation: spin 3s linear infinite;
  }
  @keyframes spin {
    100% { transform: rotate(360deg); }
  }
  /* Animations boutons */
  .play-btn:hover {
    animation: bounce 0.5s;
  }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }
  .sticker-anim {
    box-shadow: 0 4px 24px 0 #00e6ff80, 0 1.5px 0 0 #fff;
    position: relative;
    z-index: 1;
  }
  .sticker-anim:hover {
    animation: wiggle 0.5s;
    box-shadow: 0 8px 32px 0 #00e6ffcc, 0 2px 0 0 #fff;
  }
  @keyframes wiggle {
    0% { transform: rotate(-2deg) scale(1.05); }
    25% { transform: rotate(2deg) scale(1.1); }
    50% { transform: rotate(-2deg) scale(1.08); }
    75% { transform: rotate(2deg) scale(1.12); }
    100% { transform: rotate(0deg) scale(1.1); }
  }
  .animate-wiggle {
    animation: wiggle 1s infinite;
    display: inline-block;
  }
  /* Animations personnalisÃ©es pour les effets */
  .star-anim { animation: star-spin 2s linear infinite; }
  @keyframes star-spin { 0% { transform: rotate(0deg) scale(1); } 50% { transform: rotate(20deg) scale(1.2); } 100% { transform: rotate(360deg) scale(1); } }
  .flame-anim { animation: flame-flicker 1.2s infinite alternate; }
  @keyframes flame-flicker { 0% { opacity: 1; transform: scale(1) rotate(-5deg);} 50% { opacity: 0.7; transform: scale(1.2) rotate(5deg);} 100% { opacity: 1; transform: scale(1) rotate(-5deg);} }
  .spark-anim { animation: spark-blink 1.5s infinite alternate; }
  @keyframes spark-blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
  .bolt-anim { animation: bolt-bounce 1s infinite alternate; }
  @keyframes bolt-bounce { 0% { transform: translateY(0) scale(1); } 50% { transform: translateY(-6px) scale(1.2); } 100% { transform: translateY(0) scale(1); } }
  .badge-anim { animation: badge-pop 1.2s infinite alternate; }
  @keyframes badge-pop { 0% { box-shadow: 0 0 0 0 #ffe066; transform: scale(1); } 100% { box-shadow: 0 0 16px 4px #ffd700; transform: scale(1.08); } }
  .playlist-title-shadow {
    text-shadow: 0 2px 8px rgba(0,0,0,0.85), 0 1px 0 #222;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const scoreFilters = document.querySelectorAll('.score-filter');
    const scoreSections = document.querySelectorAll('.score-section');
    const totalSection = document.getElementById('total-section');
    const categoriesSection = document.getElementById('categories-section');
    const playlistsSection = document.getElementById('playlists-section');
    const myScoresSection = document.getElementById('my-scores-section');
    
    // Initialisation - montrer toutes les sections sauf "Mes scores"
    function showAllSections() {
      scoreSections.forEach(section => {
        if (section.id === 'my-scores-section') {
          section.style.display = 'none';
        } else {
          section.style.display = 'block';
        }
      });
    }
    
    // Par dÃ©faut, montrer toutes les sections sauf "Mes scores"
    showAllSections();
    
    // Gestion des filtres
    scoreFilters.forEach(filter => {
      filter.addEventListener('click', function() {
        // Mettre Ã  jour l'Ã©tat actif
        scoreFilters.forEach(f => f.classList.remove('active'));
        this.classList.add('active');
        
        const target = this.getAttribute('data-target');
        
        // Afficher les sections appropriÃ©es
        if (target === 'all') {
          // Afficher toutes les sections sauf "Mes scores"
          showAllSections();
        } else if (target === 'my') {
          // Afficher seulement "Mes scores"
          scoreSections.forEach(section => {
            if (section.id === 'my-scores-section') {
              section.style.display = 'block';
            } else {
              section.style.display = 'none';
            }
          });
        }
        
        // Scroll en douceur vers le haut de la section
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    });
  });
</script>
