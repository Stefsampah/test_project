<!DOCTYPE html>
<html>
  <head>
    <title>Tube'NPlay</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= favicon_link_tag "logo/Copilot_20251006_162220.png" %>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload" %>
    <style>
      /* Navigation Styles */
      .nav {
        background-color: #111827;
        color: white;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      
      .nav-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
        position: relative;
      }
      
      .nav-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 64px;
      }
      
      .logo {
        display: flex;
        align-items: center;
        font-weight: bold;
        font-size: 1.25rem;
        color: white;
        text-decoration: none;
        transition: all 0.3s ease;
        padding: 0.5rem;
        border-radius: 0.375rem;
      }
      
      .logo:hover {
        background-color: rgba(255, 255, 255, 0.1);
        transform: scale(1.05);
      }
      
      .logo svg {
        width: 32px;
        height: 32px;
        margin-right: 0.5rem;
      }
      
      .main-menu {
        display: flex;
        gap: 1.5rem;
      }
      
      .user-menu {
        display: flex;
        gap: 1rem;
      }
      
      .nav-link {
        color: #e5e7eb;
        text-decoration: none;
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        z-index: 1002;
      }
      
      .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        transform: scale(1.05);
      }
      
      .mobile-menu-button {
        display: none;
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 0.5rem;
      }
      
      .mobile-menu {
        display: none;
        flex-direction: column;
        padding: 0;
        background-color: #1f2937;
        border-radius: 0 0 0.5rem 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
      }
      
      .mobile-menu.show {
        display: flex;
        padding: 1rem 0;
      }
      
      .mobile-menu .nav-link {
        padding: 0.75rem 1rem;
        border-radius: 0;
        font-size: 1rem;
      }
      
      .mobile-menu .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.05);
      }
      
      /* Flash messages */
      .flash {
        max-width: 1200px;
        margin: 1rem auto;
        padding: 0 1rem;
      }
      
      .flash-notice, .flash-alert {
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
      }
      
      .flash-notice {
        background-color: #10b981;
        color: white;
      }
      
      .flash-alert {
        background-color: #ef4444;
        color: white;
      }
      
      .main-content {
        min-height: calc(100vh - 64px);
      }
      
      /* Responsive styles */
      @media (max-width: 1024px) {
        .main-menu, .user-menu {
          display: none;
        }
        
        .mobile-menu-button {
          display: block;
        }
        
        .logo {
          font-size: 1rem;
          padding: 0.25rem;
        }
        
        .logo svg,
        .logo img {
          width: 24px;
          height: 24px;
        }
        
        .nav-content {
          height: auto;
          min-height: 47px;
        }
      }
    </style>
  </head>

  <body class="bg-gray-900 text-white">
    <nav class="nav">
      <div class="nav-container">
        <div class="nav-content">
          <!-- Logo -->
          <a href="<%= root_path %>" class="logo" title="Accueil - Tube'NPlay" onclick="window.location.href='<%= root_path %>'; return false;">
            <%= image_tag "logo/Copilot_20251006_162220.png", alt: "Tube'NPlay", class: "w-8 h-8 mr-2 object-contain" %>
            <span>Tube'<span style="color: #9333ea;">N</span>Play</span>
          </a>

          <!-- Menu principal -->
          <div class="main-menu">
            <%= link_to t('nav.playlists'), playlists_path, class: "nav-link" %>
            <%= link_to t('nav.scores'), scores_path, class: "nav-link" %>
            <%= link_to t('nav.badges'), my_badges_path, class: "nav-link" %>
            <%= link_to t('nav.rewards'), my_rewards_path, class: "nav-link" %>
            <%= link_to "Boutique", store_path, class: "nav-link" %>
          </div>

          <!-- Menu utilisateur -->
          <div class="user-menu">
            <!-- SÃ©lecteur de langue -->
            <div class="language-selector" style="display: flex; gap: 0.5rem; align-items: center; margin-right: 1rem;">
              <%= link_to "FR", change_locale_path(:fr), class: "nav-link #{'font-bold text-purple-400' if I18n.locale == :fr}", style: "padding: 0.25rem 0.5rem; min-width: 32px; text-align: center;" %>
              <span class="text-gray-500">|</span>
              <%= link_to "EN", change_locale_path(:en), class: "nav-link #{'font-bold text-purple-400' if I18n.locale == :en}", style: "padding: 0.25rem 0.5rem; min-width: 32px; text-align: center;" %>
            </div>
            
            <% if user_signed_in? %>
              <span class="nav-link text-green-400 font-medium">
                <%= current_user.email %>
              </span>
              <%= link_to t('nav.profile'), profile_path, class: "nav-link" %>
              <%= form_with url: destroy_user_session_path, method: :delete, local: true, class: "inline" do |f| %>
                <%= f.submit t('nav.sign_out'), class: "nav-link bg-transparent border-0 cursor-pointer" %>
              <% end %>
            <% else %>
              <%= link_to t('nav.sign_in'), new_user_session_path, class: "nav-link" %>
            <% end %>
          </div>

          <!-- Bouton menu mobile -->
          <button class="mobile-menu-button" id="mobile-menu-button" aria-label="Menu" aria-expanded="false" aria-controls="mobile-menu">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>

        <!-- Menu mobile -->
        <div class="mobile-menu" id="mobile-menu">
          <%= link_to "Playlists", playlists_path, class: "nav-link" %>
          <%= link_to "Scores", scores_path, class: "nav-link" %>
          <%= link_to "Badges", my_badges_path, class: "nav-link" %>
          <%= link_to "RÃ©compenses", my_rewards_path, class: "nav-link" %>
          <%= link_to "Boutique", store_path, class: "nav-link" %>
          
          <% if user_signed_in? %>
            <div class="border-t border-gray-700 my-2"></div>
            <span class="nav-link text-green-400 font-medium">
              <%= current_user.email %>
            </span>
            <%= link_to "Mon Profil", profile_path, class: "nav-link" %>
            <%= form_with url: destroy_user_session_path, method: :delete, local: true, class: "inline w-full" do |f| %>
              <%= f.submit "DÃ©connexion", class: "nav-link text-left w-full bg-transparent border-0 cursor-pointer" %>
            <% end %>
          <% else %>
            <div class="border-t border-gray-700 my-2"></div>
            <%= link_to "Connexion", new_user_session_path, class: "nav-link" %>
          <% end %>
        </div>
      </div>
    </nav>

    <!-- Messages flash -->
    <% if notice %>
      <div class="flash">
        <div class="flash-notice">
          <%= notice.html_safe %>
        </div>
      </div>
    <% end %>

    <% if alert %>
      <div class="flash">
        <div class="flash-alert">
          <%= alert.html_safe %>
        </div>
      </div>
    <% end %>

    <!-- Notification partie en cours -->
    <% if user_signed_in? && has_game_in_progress? %>
      <% game = current_game_in_progress %>
      <% # Ne pas afficher la notification sur les pages de jeu %>
      <% is_game_page = request.path.match?(%r{/playlists/\d+/games(/\d+)?(/swipe|/results)?$}) %>
      <% unless is_game_page %>
        <div class="flash" id="game-in-progress-notification">
          <div class="flash-notice" style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap; font-size: 1rem;">
            <span style="flex: 1; min-width: 200px; font-size: 1rem;">
              ðŸŽ® Vous avez une partie en cours : <strong><%= game.playlist.title %></strong>
            </span>
            <%= link_to "Reprendre la partie", playlist_game_path(game.playlist, game), 
                class: "bg-white text-green-600 px-4 py-2 rounded font-semibold hover:bg-gray-100 transition-colors",
                style: "text-decoration: none; white-space: nowrap; flex-shrink: 0; font-size: 1rem;" %>
          </div>
        </div>
      <% end %>
    <% end %>

    <div class="main-content">
      <%= yield %>
    </div>

    <script>
      (function() {
        // Utiliser window pour Ã©viter les conflits de variables
        if (!window.mobileMenuInitialized) {
          window.mobileMenuDocumentClick = null;
          window.mobileMenuKeydown = null;
          window.mobileMenuInitialized = true;
        }

        function setupMobileMenu() {
          console.log('setupMobileMenu called');
          const mobileMenuButton = document.getElementById('mobile-menu-button');
          const mobileMenu = document.getElementById('mobile-menu');
          const nav = document.querySelector('.nav');
          
          console.log('mobileMenuButton:', mobileMenuButton);
          console.log('mobileMenu:', mobileMenu);
          console.log('nav:', nav);
          
          if (!mobileMenuButton || !mobileMenu) {
            console.log('Menu elements not found');
            return;
          }

          if (window.mobileMenuDocumentClick) document.removeEventListener('click', window.mobileMenuDocumentClick);
          if (window.mobileMenuKeydown) document.removeEventListener('keydown', window.mobileMenuKeydown);

          function closeMobileMenuDirect(menuElement, buttonElement) {
            menuElement.classList.remove('show');
            menuElement.style.display = 'none';
            buttonElement.setAttribute('aria-expanded', 'false');
            buttonElement.innerHTML = `
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            `;
          }

          function openMobileMenuDirect(menuElement, buttonElement) {
            console.log('openMobileMenuDirect called with elements:', menuElement, buttonElement);
            menuElement.classList.add('show');
            
            // Forcer l'application des styles CSS
            menuElement.style.display = 'flex';
            menuElement.style.position = 'absolute';
            menuElement.style.top = '100%';
            menuElement.style.left = '0';
            menuElement.style.right = '0';
            menuElement.style.width = '100%';
            menuElement.style.backgroundColor = '#1f2937';
            menuElement.style.zIndex = '1001';
            menuElement.style.padding = '1rem 0';
            menuElement.style.borderRadius = '0 0 0.5rem 0.5rem';
            menuElement.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.1)';
            menuElement.style.flexDirection = 'column';
            
            console.log('Menu classes after adding show:', menuElement.className);
            console.log('Menu display style:', window.getComputedStyle(menuElement).display);
            console.log('Menu position:', window.getComputedStyle(menuElement).position);
            console.log('Menu top:', window.getComputedStyle(menuElement).top);
            console.log('Menu left:', window.getComputedStyle(menuElement).left);
            console.log('Menu width:', window.getComputedStyle(menuElement).width);
            console.log('Menu height:', window.getComputedStyle(menuElement).height);
            console.log('Menu z-index:', window.getComputedStyle(menuElement).zIndex);
            console.log('Menu background:', window.getComputedStyle(menuElement).backgroundColor);
            console.log('Menu is visible:', menuElement.offsetParent !== null);
            console.log('Menu offsetHeight:', menuElement.offsetHeight);
            console.log('Menu offsetWidth:', menuElement.offsetWidth);
            console.log('Menu innerHTML length:', menuElement.innerHTML.length);
            buttonElement.setAttribute('aria-expanded', 'true');
            buttonElement.innerHTML = `
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            `;
          }

          // Utiliser la dÃ©lÃ©gation d'Ã©vÃ©nement au niveau du document
          // Nettoyer l'ancien Ã©couteur global
          if (window.mobileMenuGlobalClick) {
            document.removeEventListener('click', window.mobileMenuGlobalClick);
          }
          
                  // CrÃ©er le gestionnaire global
        window.mobileMenuGlobalClick = function(event) {
          // VÃ©rifier si on clique spÃ©cifiquement sur le bouton du menu mobile
          const mobileMenuButton = event.target.closest('#mobile-menu-button');
          if (mobileMenuButton && !event.target.closest('.logo')) {
            console.log('Mobile menu button clicked!');
            event.preventDefault();
            event.stopPropagation();
            
            // RÃ©cupÃ©rer les Ã©lÃ©ments actuels Ã  chaque clic
            const currentMobileMenu = document.getElementById('mobile-menu');
            const currentMobileMenuButton = document.getElementById('mobile-menu-button');
            console.log('Current mobile menu found:', currentMobileMenu);
            console.log('Current mobile menu button found:', currentMobileMenuButton);
            
            if (currentMobileMenu && currentMobileMenu.classList.contains('show')) {
              console.log('Closing mobile menu');
              closeMobileMenuDirect(currentMobileMenu, currentMobileMenuButton);
            } else if (currentMobileMenu) {
              console.log('Opening mobile menu');
              openMobileMenuDirect(currentMobileMenu, currentMobileMenuButton);
            }
          }
        };
          
          // Attacher l'Ã©couteur global
          document.addEventListener('click', window.mobileMenuGlobalClick);

          mobileMenu.onclick = function(event) {
            if (event.target.closest('a, button')) {
              setTimeout(() => {
                closeMobileMenuDirect(mobileMenu, mobileMenuButton);
              }, 100);
            }
            event.stopPropagation();
          };

          window.mobileMenuDocumentClick = function(event) {
            if (mobileMenu.classList.contains('show') && !nav.contains(event.target)) {
              closeMobileMenuDirect(mobileMenu, mobileMenuButton);
            }
          };
          document.addEventListener('click', window.mobileMenuDocumentClick);

          window.mobileMenuKeydown = function(event) {
            if (event.key === 'Escape' && mobileMenu.classList.contains('show')) {
              closeMobileMenuDirect(mobileMenu, mobileMenuButton);
            }
          };
          document.addEventListener('keydown', window.mobileMenuKeydown);
        }

        document.addEventListener('turbo:before-cache', function() {
          if (window.mobileMenuDocumentClick) document.removeEventListener('click', window.mobileMenuDocumentClick);
          if (window.mobileMenuKeydown) document.removeEventListener('keydown', window.mobileMenuKeydown);
          if (window.mobileMenuGlobalClick) document.removeEventListener('click', window.mobileMenuGlobalClick);
        });

        document.addEventListener('turbo:load', function() {
          setTimeout(setupMobileMenu, 100);
        });
        document.addEventListener('DOMContentLoaded', setupMobileMenu);
        
        // Gestionnaire pour le logo (supprimÃ© pour Ã©viter les conflits avec Turbo)
      })();
    </script>
  </body>
</html>
